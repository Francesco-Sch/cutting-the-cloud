---
const { temperature_limit, order } = Astro.props;
---

<script>
	import { temperatures } from "../stores/temperature.js";

	class TemperatureTrigger extends HTMLElement {
		constructor() {
			super();

			const temperature_limit = this.dataset.temperatureLimit;
			const order = this.dataset.order;

			// Add data to store
			let tempTemperatures = temperatures.get();

			tempTemperatures[order] = {
				temperature_limit: temperature_limit,
				visible: false,
			};

			temperatures.set(tempTemperatures);

			// If this container goes into viewport then set visible to true
			this.observer = new IntersectionObserver(
				(entries) => {
					entries.forEach((entry) => {
						let tempTemperatures = temperatures.get();

						// Get data for the specific element that triggered the callback
						const targetElement = entry.target;
						const order = targetElement.dataset.order;
						const temperature_limit = targetElement.dataset.temperatureLimit;

						if (entry.isIntersecting) {
							// Update data for the specific element that is in view
							tempTemperatures[order] = {
								temperature_limit: temperature_limit,
								visible: true,
							};
						} else {
							// Update data for the specific element that is out of view
							tempTemperatures[order] = {
								temperature_limit: temperature_limit,
								visible: false,
							};
						}

						temperatures.set(tempTemperatures);
					});
				},
				{ threshold: 0.5 }
			); // Moved threshold option here

			this.observer.observe(this);
		}

		// Add the disconnectedCallback function
		disconnectedCallback() {
			if (this.observer) {
				this.observer.disconnect();
			}
		}
	}

	customElements.define("temperature-trigger", TemperatureTrigger);
</script>

<temperature-trigger
	id="temperature-trigger"
	class="invisible"
	data-temperature-limit={temperature_limit}
	data-order={order}
>
</temperature-trigger>
